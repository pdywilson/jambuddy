<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Jam Buddy</title>
    <style type="text/css">
        * {
            margin: 0px;
            padding: 0px;
        }

        #CSConsole {
            background-color: #FAFAFA;
            border-top: 1px solid #333333;
            bottom: 0px;
            height: 200px;
            overflow-y: scroll;
            position: fixed;
            width: 100%;
        }
    </style>

<script type="text/javascript" src="Cindy.js"></script>

<!-- Load TensorFlow.js -->

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"> </script>
<script src="tonal.min.js"></script>

<script type="module" >

</script>


<script type="text/javascript" >

</script>

<script id="csdraw" type="text/x-cindyscript">
bpm=120;
drawtext((1.5,1.6),"bpm: " + bpm, size->20);
drawtext((1.5,1.5),"beat: " + beat, size->20);

timestep = bpm/60*(seconds() - timer);

if(beatcounted > 0,
    beatcounted = beatcounted + 1;
    if(beatcounted > 5,
        beatcounted = 0;
    );
);

if(beatcounted == 0
    & timestep - floor(timestep) <= 0.05,
    secs = seconds();
    beat = mod(beat,8) + 1;
    beatcounted = beatcounted + 1;
    if(beat == 8 & inputmelody != [],
        continueSequence(
            inputmelody,
            melody = m;
            errc(melody);
            playmelody(melody);
        );
        inputmelody=[];
    );
    //print(seconds()-secs); ~0.07-0.1 verzoegerung
);

forall(1..30,
    if(keyson_#==1,
        currentkeys_# = currentkeys_#+1/24;,
        if(currentkeys_#!=0,
            inputmelody=inputmelody++[[#+59,seconds()-timer,seconds()-timer+currentkeys_#]];
            currentkeys_#=0,
        );
    );
);


ls=alllines();
apply(ls,l,l.selected=false);

if(German.pressed,

keys=["A","W","S","E","D","F","T","G","Z","H","U","J","K","O","L","P","º","Þ","Ý","Ü",
    "Y","X","C","V","B","N","M","¼","¾","¿";];
    drawtext((-0.9,0.4),"W E    T Z U   O P",size->41);
    drawtext((-1,0),"A S D F G H J K L Ö Ä",size->40);,

keys=["A","W","S","E","D","F","T","G","Y","H","U","J","K","O","L","P","º","Þ","Ý","Ü",
    "Z","X","C","V","B","N","M","¼","¾","¿";];//23+10
    drawtext((-0.9,0.4),"W E    T Y U   O P",size->41);
    drawtext((-1,0),"A S D F G H J K L Ö Ä",size->40);
);

keypos(n) := (
    c = 0;
    if(n==0,c=0);
    if(n==1,c=0);
    if(n==2,c=1);
    if(n==3,c=1);
    if(n==4,c=2);
    if(n==5,c=3);
    if(n==6,c=3);
    if(n==7,c=4);
    if(n==8,c=4);
    if(n==9,c=5);
    if(n==10,c=5);
    if(n==11,c=6);
    //if(n<5,c=floor(n/2),c=ceil(n/2));
    c;
);

blackkeys = [2,4,7,9,11];
drawkeyw(n) := (
    if(!contains(blackkeys,mod(n,12)),
        octave = floor(n/12);
        keynr = keypos(mod(n,12)+1);
        pos = (octave*7+keynr)/3-2.8;
        if (keyson_n == 1, c = .5;, c = .3;);
        kh = -0.5;
        w = 0.3;
        l = 1;
        fillpoly(((pos-w,kh),(pos,kh),(pos,kh-l),(pos-w,kh-l)),color->[1,1,1]*c);
    );
);

drawkeyb(n) := (
    if(contains(blackkeys, mod(n,12)),
        octave = floor(n/12);
        keynr = keypos(mod(n,12));
        pos = ((octave*7+keynr)+0.35)/3-2.8;
        if (keyson_n == 1, c = .4;, c = .1;);
        kh = -0.5;
        w = 0.2;
        l = 0.6;
        fillpoly(((pos-w,kh),(pos,kh),(pos,kh-l),(pos-w,kh-l)),color->[1,1,1]*c);
    );
);

forall(1..30,drawkeyw(#););
forall(1..30,drawkeyb(#););

;


//call continueSequence here and with callback? get continued sequence.
//ToDo: function that plays sequence (in sequencer?) maybe use midi for that

</script>

<script id="cskeydown" type="text/x-cindyscript">


forall(keylist,
    if(key() == keys_# & keyson_# == 0,
      play(#);
      keyson_#=1;
    );
);

forall(specialkeyslist,
    if(key() == specialkeys_# & specialkeyson_# == 0,
      playchord(#);
      specialkeyson_#=1;
  );
);

</script>


<script id="cskeyup" type="text/x-cindyscript">
forall(keylist,
    if(key()==keys_#,
        playdamp(#);
        keyson_#=0;
    );
);

forall(specialkeyslist,
    if(key()==specialkeys_#,
        playdampchord(#);
        specialkeyson_#=0;
    );
);

</script>
<script id="csmousedown" type="text/x-cindyscript">

;
</script>
<script id="csmousedrag" type="text/x-cindyscript">


;
</script>
<script id="csmouseup" type="text/x-cindyscript">

</script>
<script id="csinit" type="text/x-cindyscript">
playtone(60);
bpm = 120;
beat = 0;
beatcounted = 0;
timer = floor(seconds());

currentkeys=(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);
inputmelody=[];

notes=(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);
keys=["A","W","S","E","D","F","T","G","Y","H","U","J","K","O","L","P","º","Þ","Ý","Ü"];
specialkeys=["Z","X","C","V","B","N","M","¼","¾","¿";];
keyson = (0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);
specialkeyson = (0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);
harms=[1];

num = 20;
keylist = 1..20;
specialkeyslist = 1..10; //zxcvbnm,./

f(n) := 2^((n-49)/12)*440;
grundton = 39; //52=C but i starts at 1
repeat(num,i,
    notes_i=f(i+grundton)
);
//grundtoene unten links
notes_(num+1)=f(grundton-11);
notes_(num+2)=f(grundton-9);
notes_(num+3)=f(grundton-7);
notes_(num+4)=f(grundton-6);
notes_(num+5)=f(grundton-4);
notes_(num+6)=f(grundton-2);
notes_(num+7)=f(grundton);
notes_(num+8)=f(grundton+1);
//special:
notes_(num+9)=f(grundton+21);
notes_(num+10)=f(grundton+22);


am=0.4;
play(i):=playsin(notes_i,amp->100*am/notes_i, damp->1, duration->4, line->i);
playdamp(i):=playsin(notes_i,amp->100*am/notes_i, damp->4, duration->4, harmonics->harms, line->i, restart->false);
playchord(i):=(
    playsin(notes_i,amp->100*am/notes_i, damp->1, duration->4, line->i+"a");
    playsin(notes_i*2^(7/12),amp->100*am/notes_i, damp->1, duration->4, line->i+"b");
    playsin(notes_i*2^(10/12),amp->100*am/notes_i, damp->1, duration->4, line->i+"c");
);
playdampchord(i):=(
    playsin(notes_i,amp->100*am/notes_i, damp->4, duration->4, line->i+"a", restart->false);
    playsin(notes_i*2^(7/12),amp->100*am/notes_i, damp->4, duration->4, line->i+"b", restart->false);
    playsin(notes_i*2^(10/12),amp->100*am/notes_i, damp->4, duration->4, line->i+"c", restart->false);
);

;
</script>

    <script type="text/javascript">
var cdy = CindyJS({
  scripts: "cs*",
  defaultAppearance: {
    dimDependent: 0.7,
    fontFamily: "sans-serif",
    lineSize: 1,
    pointSize: 5.0,
    textsize: 12.0
  },
  angleUnit: "°",
  geometry: [
    {name: "German", type: "ToggleButton", pos: [-1.8,-1.8], color: [0.0, 0.0, 0.0], fillcolor: [1.0, 1.0, 1.0], fillalpha: 1.0, alpha: 0.8999999761581421, text: "German Keyboard!"}
  ],
  autoplay: true,
  keylistener: true,
  use: ["midi","onnxrnn"],
  ports: [{
    id: "CSCanvas",
    width: 1920,
    height: 1440,
    fill: "window",
    transform: [{visibleRect: [-2,2,2,-2]}],
    background: "rgb(50,50,50)"
  }],
  cinderella: {build: 1847, version: [2, 9, 1847]}
});
    </script>
</head>
<body>
    <div id="CSCanvas"></div>

</body>
</html>
